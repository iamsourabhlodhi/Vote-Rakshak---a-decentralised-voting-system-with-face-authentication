<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cast Vote - Election Portal</title>
<link rel="stylesheet" href="style.css">
<!-- MediaPipe FaceMesh -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>

<body>

<div class="strip"></div>
<header class="gov-header">
  <div style="display:flex;align-items:center;gap:10px">
    <img src="https://i.ibb.co/gZ4NyZQ/emblem-black.png" width="42">
    <div><b>Election Commission of India</b><br><small>Digital Voting System</small></div>
  </div>
  <nav class="top-links">
    <a href="/">Home</a><a href="/results">Results</a><a href="/admin">Admin</a>
  </nav>
</header>

<div class="container">
<div class="card grid">

<!-- Left -->
<div>
<label class="label">Enrollment Number</label>
<input id="enroll" class="input" placeholder="Enter enrollment">

<label class="label">Face Verification</label>
<div class="video-wrap">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;"></canvas>
  <div id="faceGuide" class="face-guide"></div>
  <div id="countdown" class="countdown"></div>
</div>

<div class="quality-bar"><div class="q-dot" id="q1"></div><div class="q-dot" id="q2"></div><div class="q-dot" id="q3"></div></div>
<div id="lightCheck" class="light-warning">Low Light</div>
<div id="blurCheck" class="blur-warning">Blurry Image</div>
<div id="poseCheck" class="pose-warning">Align Face</div>

<button id="cap" class="btn" style="margin-top:10px">Capture</button>
<button id="cast" class="btn secondary" style="margin-top:10px">Submit Vote</button>

<div id="previewBox"><p>Captured:</p><img id="previewImg"></div>
<p id="msg" class="small">Align face. Auto capture will trigger.</p>
</div>

<!-- Right -->
<div>
<h3>Select Candidate</h3>
<div id="listCandidates"></div>
</div>

</div>
</div>

<script>
let captured=null,stable=0,auto=true;

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const guide=document.getElementById("faceGuide");
const countdown=document.getElementById("countdown");
const preview=document.getElementById("previewImg");

/* ========= Setup FaceMesh ========= */
const faceMesh=new FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
faceMesh.setOptions({
  maxNumFaces:1,
  refineLandmarks:true,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});

faceMesh.onResults(drawFace);

async function start(){
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
  const cam=new Camera(video,{onFrame:async()=>{await faceMesh.send({image:video});},width:640,height:480});
  cam.start();
}
start();

/* ========= Face event handler ========= */
function drawFace(results){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;

  if(!results.multiFaceLandmarks.length){
    guide.style.display="none";
    stable=0;auto=true;
    return;
  }

  const lm=results.multiFaceLandmarks[0];

  const xs=lm.map(p=>p.x*canvas.width);
  const ys=lm.map(p=>p.y*canvas.height);
  const minX=Math.min(...xs), maxX=Math.max(...xs);
  const minY=Math.min(...ys), maxY=Math.max(...ys);

  const w=maxX-minX, h=maxY-minY;
  const size=Math.max(w,h)*1.3;

  guide.style.display="block";
  guide.style.width=size+"px";
  guide.style.height=size+"px";
  guide.style.left=(minX+w/2-size/2)+"px";
  guide.style.top=(minY+h/2-size/2)+"px";

  stable++;
  qualityDots(3); // (we can integrate blur later)

  guide.className="face-guide good";
  if(stable>40 && auto){ auto=false; triggerAutoCap(); }
}

/* ========= Auto capture ========= */
function triggerAutoCap(){
  countdown.style.display="flex";
  let s=3;
  countdown.innerText=s;
  let t=setInterval(()=>{
    s--; countdown.innerText=s;
    if(s<=0){
      clearInterval(t);countdown.style.display="none";
      captureFrame();
    }
  },700);
}

document.getElementById("cap").onclick=captureFrame;
function captureFrame(){
  const c=document.createElement("canvas");
  c.width=video.videoWidth;c.height=video.videoHeight;
  const x=c.getContext("2d");
  x.translate(c.width,0);x.scale(-1,1);
  x.drawImage(video,0,0);
  captured=c.toDataURL("image/jpeg",0.9);
  preview.src=captured;
  preview.parentElement.style.display="block";
}

/* UI Quality Dots */
function qualityDots(n){
  [q1,q2,q3].forEach(e=>e.className="q-dot");
  if(n>=1)q1.classList.add("q-good");
  if(n>=2)q2.classList.add("q-good");
  if(n>=3)q3.classList.add("q-good");
}

/* Load candidates */
async function loadCandidates(){
  const r=await fetch("/candidates");
  const d=await r.json();
  const box=document.getElementById("listCandidates");
  box.innerHTML="";
  d.forEach(c=>{
    let el=document.createElement("div");
    el.className="candidate";
    el.innerHTML=`<strong>${c.id}. ${c.name}</strong><input type="radio" name="candidate" value="${c.id}">`;
    box.appendChild(el);
  });
}
loadCandidates();

/* Submit vote */
document.getElementById("cast").onclick=async()=>{
  const e=document.getElementById("enroll").value.trim();
  const s=document.querySelector("input[name='candidate']:checked");
  if(!e)return msg.innerText="Enter enrollment";
  if(!captured)return msg.innerText="Capture face";
  if(!s)return msg.innerText="Select candidate";

  const f=new FormData();
  f.append("enrollment",e);
  f.append("candidate_id",s.value);
  f.append("image",captured);

  const res=await fetch("/vote",{method:"POST",body:f});
  msg.innerText=res.ok?"Vote submitted ✔": "Failed ❌";
};
</script>

</body>
</html>
